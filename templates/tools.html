{% extends "base.html" %}

{% block title %}Tools{% endblock %}

{% block content %}
<h1>Analysis Tools</h1>
<p class="subtitle">Portfolio optimization and opportunity screening</p>

<!-- Portfolio Generator -->
<div class="glass card mb-1">
    <h3>Portfolio Generator</h3>
    <p class="text-muted mb-1">Generate optimized cryptocurrency portfolio based on name patterns</p>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
        <div>
            <label>Portfolio Size</label>
            <input type="number" id="portfolio-size" value="10" min="5" max="50" style="width: 100%; padding: 0.5rem;">
        </div>
        <div>
            <label>Strategy</label>
            <select id="portfolio-strategy" style="width: 100%; padding: 0.5rem;">
                <option value="balanced">Balanced</option>
                <option value="growth">Growth</option>
                <option value="conservative">Conservative</option>
            </select>
        </div>
        <div style="display: flex; align-items: flex-end;">
            <button class="btn btn-primary" onclick="generatePortfolio()" style="width: 100%;">Generate Portfolio</button>
        </div>
    </div>
    
    <div id="portfolio-results" style="display: none;">
        <h4 style="margin-top: 1.5rem; margin-bottom: 0.75rem;">Generated Portfolio</h4>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Cryptocurrency</th>
                        <th>Allocation %</th>
                        <th>Score</th>
                        <th>Risk Level</th>
                    </tr>
                </thead>
                <tbody id="portfolio-tbody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Opportunity Scanner -->
<div class="glass card">
    <h3>Opportunity Scanner</h3>
    <p class="text-muted mb-1">High-confidence investment opportunities</p>
    
    <div id="opportunities-list">
        <p>Loading opportunities...</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
async function loadTools() {
    try {
        // Load opportunities
        const opportunities = await fetch('/api/opportunities/undervalued-cryptos?min_score=80&min_rank=100').then(r => r.json());
        renderOpportunities(opportunities);
    } catch (error) {
        console.error('Error loading tools:', error);
    }
}

function renderOpportunities(opps) {
    const container = document.getElementById('opportunities-list');
    
    if (!opps || opps.length === 0) {
        container.innerHTML = '<p class="text-muted">No high-confidence opportunities at this time</p>';
        return;
    }
    
    container.innerHTML = opps.slice(0, 10).map((opp, idx) => `
        <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
            <div class="flex-between">
                <div>
                    <strong>${idx + 1}. ${opp.name}</strong>
                    <span class="text-muted" style="margin-left: 0.5rem;">${opp.symbol} | Rank #${opp.rank}</span>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.2rem; font-weight: 700;">Score: ${Math.round(opp.score)}</div>
                </div>
            </div>
        </div>
    `).join('');
}

async function generatePortfolio() {
    const size = document.getElementById('portfolio-size').value;
    const strategy = document.getElementById('portfolio-strategy').value;
    
    try {
        const topScores = await fetch(`/api/signals/top?min_score=70&limit=${size * 2}`).then(r => r.json());
        
        if (!topScores || topScores.length < size) {
            alert('Not enough qualifying cryptocurrencies found');
            return;
        }
        
        // Simple allocation
        const selected = topScores.slice(0, size);
        const tbody = document.getElementById('portfolio-tbody');
        
        tbody.innerHTML = selected.map(s => `
            <tr>
                <td><strong>${s.name}</strong></td>
                <td>${(100 / size).toFixed(1)}%</td>
                <td>${Math.round(s.score)}</td>
                <td>Medium</td>
            </tr>
        `).join('');
        
        document.getElementById('portfolio-results').style.display = 'block';
        
    } catch (error) {
        alert('Error generating portfolio: ' + error);
    }
}

loadTools();
</script>
{% endblock %}

