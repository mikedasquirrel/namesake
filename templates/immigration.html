{% extends "base.html" %}

{% block title %}Immigration Semantic Analysis - Interactive Dashboard{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">

<!-- Header -->
<div style="text-align: center; margin-bottom: 2rem;">
    <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Immigration Surname Semantic Analysis</h1>
    <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 0.5rem;">
        Interactive Dashboard - Explore Etymology & Immigration Patterns
    </p>
    <p style="font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 1rem;">
        Galilei (from Galilee) vs Shoemaker (makes shoes) - Does meaning predict migration?
    </p>
    <div>
        <a href="/immigration" class="btn-secondary">‚Üê Research Findings</a>
    </div>
</div>

<!-- Stats Overview -->
<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 2rem;">
    <div class="glass card" style="text-align: center; padding: 1.5rem;">
        <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.25rem;" id="total-surnames">-</div>
        <div style="font-size: 0.9rem; color: var(--text-muted);">Total Surnames</div>
    </div>
    
    <div class="glass card" style="text-align: center; padding: 1.5rem;">
        <div style="font-size: 2rem; font-weight: 700; color: #9c27b0; margin-bottom: 0.25rem;" id="toponymic-count">-</div>
        <div style="font-size: 0.9rem; color: var(--text-muted);">üó∫Ô∏è Toponymic</div>
    </div>
    
    <div class="glass card" style="text-align: center; padding: 1.5rem;">
        <div style="font-size: 2rem; font-weight: 700; color: #2196f3; margin-bottom: 0.25rem;" id="occupational-count">-</div>
        <div style="font-size: 0.9rem; color: var(--text-muted);">üëû Occupational</div>
    </div>
    
    <div class="glass card" style="text-align: center; padding: 1.5rem;">
        <div style="font-size: 2rem; font-weight: 700; color: #ff9800; margin-bottom: 0.25rem;" id="descriptive-count">-</div>
        <div style="font-size: 0.9rem; color: var(--text-muted);">üë§ Descriptive</div>
    </div>
    
    <div class="glass card" style="text-align: center; padding: 1.5rem;">
        <div style="font-size: 2rem; font-weight: 700; color: #4caf50; margin-bottom: 0.25rem;" id="patronymic-count">-</div>
        <div style="font-size: 0.9rem; color: var(--text-muted);">üë®‚Äçüë¶ Patronymic</div>
    </div>
</div>

<!-- Search & Filters -->
<div class="glass card" style="padding: 1.5rem; margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1rem;">Search Surnames by Semantic Meaning</h2>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Surname</label>
            <input type="text" id="search-query" placeholder="e.g., Galilei, Shoemaker, Romano, Smith..." 
                   style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--background-secondary); color: var(--text-primary);">
        </div>
        
        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Origin Language</label>
            <select id="origin-filter" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--background-secondary); color: var(--text-primary);">
                <option value="">All Origins</option>
                <option value="Italian">Italian</option>
                <option value="English">English</option>
                <option value="German">German</option>
                <option value="Spanish">Spanish</option>
                <option value="French">French</option>
                <option value="Irish">Irish</option>
                <option value="Polish">Polish</option>
                <option value="Russian">Russian</option>
                <option value="Greek">Greek</option>
                <option value="Jewish">Jewish</option>
            </select>
        </div>
        
        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Semantic Category</label>
            <select id="category-filter" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--background-secondary); color: var(--text-primary);">
                <option value="">All Categories</option>
                <option value="toponymic">üó∫Ô∏è Toponymic (Place)</option>
                <option value="occupational">üëû Occupational (Job)</option>
                <option value="descriptive">üë§ Descriptive (Trait)</option>
                <option value="patronymic">üë®‚Äçüë¶ Patronymic (Father)</option>
                <option value="religious">‚õ™ Religious</option>
            </select>
        </div>
        
        <div>
            <button onclick="searchSurnames()" class="btn-primary" style="padding: 0.5rem 1.5rem;">Search</button>
        </div>
    </div>
    
    <!-- Quick Filters -->
    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button onclick="quickFilter('toponymic')" class="btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">üó∫Ô∏è Toponymic Only</button>
        <button onclick="quickFilter('occupational')" class="btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">üëû Occupational Only</button>
        <button onclick="quickFilter('descriptive')" class="btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">üë§ Descriptive Only</button>
        <button onclick="quickFilter('patronymic')" class="btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">üë®‚Äçüë¶ Patronymic Only</button>
        <button onclick="quickFilter('')" class="btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Clear Filters</button>
    </div>
</div>

<!-- Search Results -->
<div class="glass card" style="padding: 1.5rem; margin-bottom: 2rem; display: none;" id="results-container">
    <h2 style="margin-bottom: 1rem;">Search Results <span id="results-count" style="color: var(--text-muted); font-size: 1rem;"></span></h2>
    
    <div id="results-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
        <!-- Results will be populated here -->
    </div>
</div>

<!-- Surname Detail View -->
<div class="glass card" style="padding: 1.5rem; margin-bottom: 2rem; display: none;" id="detail-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0;">Surname Detail: <span id="detail-surname"></span></h2>
        <button onclick="closeDetail()" class="btn-secondary" style="padding: 0.5rem 1rem;">Close</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
        <!-- Left Column: Etymology & Classification -->
        <div>
            <div style="background: var(--background-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h3 style="font-size: 1.05rem; margin-bottom: 1rem;">Etymology & Meaning</h3>
                <div id="detail-etymology" style="font-size: 0.9rem; line-height: 1.8;">
                    <!-- Etymology details -->
                </div>
            </div>
            
            <div style="background: var(--background-secondary); padding: 1.5rem; border-radius: 8px;">
                <h3 style="font-size: 1.05rem; margin-bottom: 1rem;">Demographics</h3>
                <div id="detail-demographics" style="font-size: 0.9rem; line-height: 1.8;">
                    <!-- Demographics details -->
                </div>
            </div>
        </div>
        
        <!-- Right Column: Immigration & Settlement -->
        <div>
            <div style="background: var(--background-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h3 style="font-size: 1.05rem; margin-bottom: 1rem;">Immigration History</h3>
                <div id="detail-immigration" style="font-size: 0.9rem;">
                    <!-- Immigration timeline -->
                </div>
            </div>
            
            <div style="background: var(--background-secondary); padding: 1.5rem; border-radius: 8px;">
                <h3 style="font-size: 1.05rem; margin-bottom: 1rem;">Settlement Patterns</h3>
                <div id="detail-settlement" style="font-size: 0.9rem;">
                    <!-- Settlement patterns -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Distribution -->
<div class="glass card" style="padding: 1.5rem; margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1rem;">Semantic Category Distribution</h2>
    <div id="category-chart" style="min-height: 250px;">
        <p style="color: var(--text-muted); text-align: center; padding: 3rem;">Loading distribution...</p>
    </div>
</div>

<!-- Example Surnames -->
<div class="glass card" style="padding: 1.5rem; margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1rem;">Example Surnames</h2>
    <div id="examples-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;">
        <!-- Examples will be populated -->
    </div>
</div>

</div>

<script>
// Category colors
const CATEGORY_COLORS = {
    'toponymic': '#9c27b0',
    'occupational': '#2196f3',
    'descriptive': '#ff9800',
    'patronymic': '#4caf50',
    'religious': '#f44336',
    'unknown': '#9e9e9e'
};

const CATEGORY_ICONS = {
    'toponymic': 'üó∫Ô∏è',
    'occupational': 'üëû',
    'descriptive': 'üë§',
    'patronymic': 'üë®‚Äçüë¶',
    'religious': '‚õ™',
    'unknown': '‚ùì'
};

// Load initial stats
async function loadStats() {
    try {
        const response = await fetch('/api/immigration/stats');
        const data = await response.json();
        
        // Update overview cards
        document.getElementById('total-surnames').textContent = data.dataset_summary.total_surnames.toLocaleString();
        document.getElementById('toponymic-count').textContent = data.semantic_category_distribution.toponymic.toLocaleString();
        document.getElementById('occupational-count').textContent = data.semantic_category_distribution.occupational.toLocaleString();
        document.getElementById('descriptive-count').textContent = data.semantic_category_distribution.descriptive.toLocaleString();
        document.getElementById('patronymic-count').textContent = data.semantic_category_distribution.patronymic.toLocaleString();
        
        // Display category distribution chart
        displayCategoryChart(data.semantic_category_distribution);
        
        // Display example surnames
        displayExampleSurnames(data.example_surnames);
        
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function displayCategoryChart(categories) {
    const chartDiv = document.getElementById('category-chart');
    
    if (!categories) {
        chartDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No data available</p>';
        return;
    }
    
    const categoryData = [
        { name: 'Toponymic', count: categories.toponymic, color: CATEGORY_COLORS.toponymic, icon: 'üó∫Ô∏è' },
        { name: 'Occupational', count: categories.occupational, color: CATEGORY_COLORS.occupational, icon: 'üëû' },
        { name: 'Descriptive', count: categories.descriptive, color: CATEGORY_COLORS.descriptive, icon: 'üë§' },
        { name: 'Patronymic', count: categories.patronymic, color: CATEGORY_COLORS.patronymic, icon: 'üë®‚Äçüë¶' },
        { name: 'Religious', count: categories.religious, color: CATEGORY_COLORS.religious, icon: '‚õ™' }
    ];
    
    const maxCount = Math.max(...categoryData.map(c => c.count));
    
    let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
    
    for (const cat of categoryData) {
        const percentage = (cat.count / maxCount) * 100;
        html += `
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 1rem; font-weight: 600;">${cat.icon} ${cat.name}</span>
                    <span style="color: var(--text-muted); font-size: 0.95rem;">${cat.count.toLocaleString()} surnames</span>
                </div>
                <div style="background: var(--background-secondary); height: 32px; border-radius: 4px; overflow: hidden;">
                    <div style="background: ${cat.color}; height: 100%; width: ${percentage}%; transition: width 0.3s; display: flex; align-items: center; padding-left: 0.5rem; color: white; font-weight: 600; font-size: 0.85rem;">
                        ${Math.round(percentage)}%
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    chartDiv.innerHTML = html;
}

function displayExampleSurnames(examples) {
    const grid = document.getElementById('examples-grid');
    
    if (!examples) {
        grid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1 / -1;">No examples available</p>';
        return;
    }
    
    let html = '';
    
    for (const [category, surnames] of Object.entries(examples)) {
        const color = CATEGORY_COLORS[category] || '#9e9e9e';
        const icon = CATEGORY_ICONS[category] || '‚ùì';
        
        html += `
            <div style="background: var(--background-secondary); padding: 1rem; border-radius: 8px; border-top: 3px solid ${color};">
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem; text-align: center;">${icon}</div>
                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.75rem; text-align: center; text-transform: capitalize; color: ${color};">${category}</div>
                <div style="font-size: 0.8rem; line-height: 1.6;">
                    ${surnames.slice(0, 5).join('<br>')}
                </div>
            </div>
        `;
    }
    
    grid.innerHTML = html;
}

function quickFilter(category) {
    document.getElementById('category-filter').value = category;
    searchSurnames();
}

async function searchSurnames() {
    const query = document.getElementById('search-query').value;
    const origin = document.getElementById('origin-filter').value;
    const category = document.getElementById('category-filter').value;
    
    // Build query string
    const params = new URLSearchParams();
    if (query) params.append('q', query);
    if (origin) params.append('origin', origin);
    if (category) params.append('category', category);
    params.append('limit', '50');
    
    try {
        const response = await fetch(`/api/immigration/search?${params}`);
        const data = await response.json();
        
        displayResults(data.surnames);
        
    } catch (error) {
        console.error('Error searching surnames:', error);
    }
}

function displayResults(surnames) {
    const container = document.getElementById('results-container');
    const grid = document.getElementById('results-grid');
    const countSpan = document.getElementById('results-count');
    
    if (!surnames || surnames.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    countSpan.textContent = `(${surnames.length} results)`;
    
    let html = '';
    for (const surname of surnames) {
        const categoryColor = CATEGORY_COLORS[surname.semantic_category] || '#9e9e9e';
        const categoryIcon = CATEGORY_ICONS[surname.semantic_category] || '‚ùì';
        
        html += `
            <div style="background: var(--background-secondary); padding: 1rem; border-radius: 8px; cursor: pointer; border-left: 4px solid ${categoryColor};" 
                 onclick="viewDetail('${surname.surname}')">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">${categoryIcon}</span>
                    <span style="font-size: 1.1rem; font-weight: 700;">${surname.surname}</span>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem;">${surname.origin_country || 'Unknown'}</div>
                <div style="font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text-secondary);">
                    <strong>Meaning:</strong> ${surname.meaning_in_original || 'Unknown'}
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                    <span style="text-transform: capitalize; color: ${categoryColor}; font-weight: 600;">${surname.semantic_category}</span>
                    <span>${surname.is_toponymic ? 'üó∫Ô∏è Place-based' : ''}</span>
                </div>
            </div>
        `;
    }
    
    grid.innerHTML = html;
}

async function viewDetail(surname) {
    try {
        const response = await fetch(`/api/immigration/surname/${surname}`);
        const data = await response.json();
        
        const container = document.getElementById('detail-container');
        container.style.display = 'block';
        container.scrollIntoView({ behavior: 'smooth' });
        
        document.getElementById('detail-surname').textContent = surname;
        
        // Etymology & Meaning
        const s = data.surname;
        const semantic = data.semantic_info;
        const categoryColor = CATEGORY_COLORS[semantic.category] || '#9e9e9e';
        const categoryIcon = CATEGORY_ICONS[semantic.category] || '‚ùì';
        
        let etymologyHtml = `
            <div style="margin-bottom: 0.75rem;">
                <strong>Meaning:</strong><br>
                <span style="font-size: 1.05rem; color: ${categoryColor};">"${semantic.meaning}"</span>
            </div>
            <div style="margin-bottom: 0.75rem;">
                <strong>Origin:</strong> ${s.origin_country || 'Unknown'}
            </div>
            <div style="margin-bottom: 0.75rem;">
                <strong>Category:</strong><br>
                <span style="color: ${categoryColor}; font-weight: 600;">${categoryIcon} ${semantic.category}</span>
            </div>
        `;
        
        if (semantic.is_toponymic && semantic.place_name) {
            etymologyHtml += `
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(156, 39, 176, 0.1); border-radius: 4px;">
                    <strong>Place Reference:</strong><br>
                    ${semantic.place_name}<br>
                    ${semantic.place_importance ? `<span style="font-size: 0.85rem;">Cultural Importance: ${semantic.place_importance}/100</span>` : ''}
                </div>
            `;
        }
        
        document.getElementById('detail-etymology').innerHTML = etymologyHtml;
        
        // Demographics
        document.getElementById('detail-demographics').innerHTML = `
            <div style="margin-bottom: 0.75rem;">
                <strong>Current Bearers:</strong><br>
                ${(s.total_bearers || 0).toLocaleString()}
            </div>
            <div style="margin-bottom: 0.75rem;">
                <strong>Frequency Rank:</strong> #${(s.frequency_rank || 0).toLocaleString()}
            </div>
        `;
        
        // Immigration history
        const immig = data.immigration_history;
        if (immig.records && immig.records.length > 0) {
            let immigHtml = `
                <div style="margin-bottom: 1rem;">
                    <strong>Total Immigrants:</strong> ${(immig.total_immigrants || 0).toLocaleString()}<br>
                    <strong>Peak Decade:</strong> ${immig.peak_decade || 'Unknown'}s
                </div>
                <div style="font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
                    <div style="display: grid; gap: 0.5rem;">
            `;
            
            for (const record of immig.records.slice(0, 14)) {
                immigHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 4px;">
                        <span>${record.year}s</span>
                        <span>${(record.immigrant_count || 0).toLocaleString()}</span>
                    </div>
                `;
            }
            
            immigHtml += '</div></div>';
            document.getElementById('detail-immigration').innerHTML = immigHtml;
        } else {
            document.getElementById('detail-immigration').innerHTML = '<p style="color: var(--text-muted);">No immigration records available</p>';
        }
        
        // Settlement patterns
        const settlement = data.settlement_patterns;
        if (settlement.primary_states && settlement.primary_states.length > 0) {
            let settleHtml = `
                <div style="margin-bottom: 1rem;">
                    <strong>Primary States:</strong><br>
                    ${settlement.primary_states.join(', ')}
                </div>
            `;
            
            if (settlement.ethnic_enclaves && settlement.ethnic_enclaves.length > 0) {
                settleHtml += `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(156, 39, 176, 0.1); border-radius: 4px;">
                        <strong>Ethnic Enclaves:</strong> ${settlement.ethnic_enclaves.length} identified
                    </div>
                `;
            }
            
            document.getElementById('detail-settlement').innerHTML = settleHtml;
        } else {
            document.getElementById('detail-settlement').innerHTML = '<p style="color: var(--text-muted);">No settlement data available</p>';
        }
        
    } catch (error) {
        console.error('Error loading surname detail:', error);
        alert('Error loading surname details');
    }
}

function closeDetail() {
    document.getElementById('detail-container').style.display = 'none';
}

// Allow Enter key to search
document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    
    document.getElementById('search-query').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            searchSurnames();
        }
    });
});
</script>

{% endblock %}
