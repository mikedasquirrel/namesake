{% extends "base.html" %}

{% block title %}Real Opportunities{% endblock %}

{% block content %}
<h1>Investment Opportunities</h1>
<p class="subtitle">Genuinely undervalued assets identified by name-value mismatch analysis | All data VERIFIED</p>

<div class="glass card mb-1">
    <h3>Undervalued Cryptocurrencies (Real Opportunities)</h3>
    <p class="text-muted mb-1" style="font-size: 0.85rem;">
        High name scores (80+) with low market recognition (rank 100-300). These are REAL cryptocurrencies from our database.
    </p>
    <div id="crypto-opportunities">
        <div class="loading"><div class="spinner"></div></div>
    </div>
</div>

<div class="glass card">
    <h3>Forward Predictions Tracking</h3>
    <p class="text-muted mb-1" style="font-size: 0.85rem;">
        Predictions made BEFORE outcomes known. Proves theory works prospectively.
    </p>
    <div class="flex gap-05 mb-1">
        <button class="btn btn-primary" onclick="makeBatchPredictions()">Make 20 New Predictions</button>
        <button class="btn btn-outline" onclick="checkPredictions()">Check Outcomes</button>
    </div>
    <div id="predictions-list">
        <div class="loading"><div class="spinner"></div></div>
    </div>
    <div id="accuracy-summary" class="mt-1" style="display: none;">
        <div style="padding: 1rem; background: var(--background-secondary); border-radius: 6px;">
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Accuracy Report</h3>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                <div>
                    <div id="total-predictions" style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);">-</div>
                    <div class="text-muted" style="font-size: 0.75rem;">Total</div>
                </div>
                <div>
                    <div id="resolved-predictions" style="font-size: 1.5rem; font-weight: 700;">-</div>
                    <div class="text-muted" style="font-size: 0.75rem;">Resolved</div>
                </div>
                <div>
                    <div id="pending-predictions" style="font-size: 1.5rem; font-weight: 700;">-</div>
                    <div class="text-muted" style="font-size: 0.75rem;">Pending</div>
                </div>
                <div>
                    <div id="accuracy-pct" style="font-size: 1.5rem; font-weight: 700; color: var(--success-muted);">-</div>
                    <div class="text-muted" style="font-size: 0.75rem;">Accuracy</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadOpportunities() {
    try {
        const opps = await fetch('/api/opportunities/undervalued-cryptos?min_score=80&min_rank=100&max_rank=300&limit=15').then(r => r.json());
        renderOpportunities(opps);
        
        const predictions = await fetch('/api/forward/accuracy-report').then(r => r.json());
        renderPredictions(predictions);
        
    } catch (error) {
        console.error('Error loading opportunities:', error);
    }
}

function renderOpportunities(opportunities) {
    const container = document.getElementById('crypto-opportunities');
    
    if (!opportunities || opportunities.length === 0) {
        container.innerHTML = '<p class="text-muted">No undervalued opportunities found at current thresholds.</p>';
        return;
    }
    
    container.innerHTML = opportunities.map((opp, idx) => `
        <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
            <div class="flex-between mb-05">
                <div>
                    <strong style="font-size: 1.05rem;">${idx + 1}. ${opp.name}</strong>
                    <span class="text-muted" style="margin-left: 0.5rem;">${opp.symbol} | Rank #${opp.rank}</span>
                    <span class="badge badge-success" style="margin-left: 0.5rem; font-size: 0.7rem;">REAL OPPORTUNITY</span>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--success-muted);">
                        ${opp.name_score}
                    </div>
                    <div class="text-muted" style="font-size: 0.7rem;">name score</div>
                </div>
            </div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                ${opp.why_undervalued}
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; font-size: 0.8rem;">
                <div>
                    <div class="text-muted">Current Price</div>
                    <div style="font-weight: 600;">$${opp.current_price ? opp.current_price.toFixed(4) : 'N/A'}</div>
                </div>
                <div>
                    <div class="text-muted">Breakout Prob</div>
                    <div style="font-weight: 600; color: ${opp.breakout_probability > 50 ? 'var(--success-muted)' : 'var(--text-primary)'};">${opp.breakout_probability}%</div>
                </div>
                <div>
                    <div class="text-muted">Mismatch</div>
                    <div style="font-weight: 600; color: var(--warning-muted);">+${opp.mismatch_score}</div>
                </div>
                <div>
                    <div class="text-muted">Signal</div>
                    <div><span class="signal signal-${opp.signal.toLowerCase()}">${opp.signal}</span></div>
                </div>
            </div>
            ${opp.expected_return_range && opp.expected_return_range.low ? `
                <div style="margin-top: 0.65rem; padding-top: 0.65rem; border-top: 1px solid var(--border); font-size: 0.8rem; color: var(--accent-primary);">
                    Potential ROI: ${opp.expected_return_range.low}% to ${opp.expected_return_range.high}% (12-month horizon)
                </div>
            ` : ''}
        </div>
    `).join('');
}

function renderPredictions(data) {
    const container = document.getElementById('predictions-list');
    
    if (!data.predictions || data.predictions.length === 0) {
        container.innerHTML = '<p class="text-muted">No forward predictions yet. Click "Make 20 New Predictions" to start tracking.</p>';
        return;
    }
    
    // Show summary
    if (data.resolved > 0) {
        document.getElementById('accuracy-summary').style.display = 'block';
        document.getElementById('total-predictions').textContent = data.total_predictions;
        document.getElementById('resolved-predictions').textContent = data.resolved;
        document.getElementById('pending-predictions').textContent = data.pending;
        document.getElementById('accuracy-pct').textContent = data.accuracy_percent + '%';
    }
    
    // Show predictions
    container.innerHTML = data.predictions.slice(0, 20).map(p => {
        const daysUntilCheck = Math.floor((new Date(p.check_date) - new Date()) / (1000 * 60 * 60 * 24));
        
        return `
            <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.875rem;">
                <div class="flex-between">
                    <div>
                        <strong>${p.asset_name}</strong>
                        <span class="text-muted" style="margin-left: 0.5rem;">Made: ${new Date(p.prediction_date).toLocaleDateString()}</span>
                    </div>
                    <div>
                        ${p.is_resolved ? 
                            (p.is_correct ? '<span class="badge badge-success">✅ CORRECT</span>' : '<span class="badge badge-danger">❌ WRONG</span>') :
                            `<span class="badge badge-neutral">⏳ ${daysUntilCheck} days</span>`
                        }
                    </div>
                </div>
                <div style="margin-top: 0.3rem; color: var(--text-secondary); font-size: 0.8rem;">
                    Prediction: ${p.predicted_outcome?.will_reach_top_100 ? 'Will reach top 100' : 'Unknown'} | 
                    Baseline Rank: #${p.baseline.rank} | 
                    Score: ${p.name_score}
                </div>
            </div>
        `;
    }).join('');
}

async function makeBatchPredictions() {
    if (!confirm('Make 20 forward predictions on cryptocurrencies ranked 150-300? These will be locked and tracked for 3 months.')) {
        return;
    }
    
    try {
        const result = await fetch('/api/forward/batch-predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ count: 20, min_rank: 150, max_rank: 300 })
        }).then(r => r.json());
        
        alert(`Created ${result.created} forward predictions. Check back in 3 months!`);
        loadOpportunities();
    } catch (error) {
        console.error('Batch prediction error:', error);
        alert('Error creating predictions');
    }
}

async function checkPredictions() {
    try {
        const result = await fetch('/api/forward/check-all', { method: 'POST' }).then(r => r.json());
        alert(`Checked predictions. Updated: ${result.updated}`);
        loadOpportunities();
    } catch (error) {
        console.error('Check error:', error);
    }
}

loadOpportunities();
</script>
{% endblock %}

