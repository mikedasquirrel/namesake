{% extends "base.html" %}

{% block title %}System{% endblock %}

{% block content %}
<div class="section-header">
    <h1>System</h1>
    <p class="subtitle">Data management, model training, and system configuration</p>
</div>

<!-- System Status -->
<div class="grid-4 mb-1">
    <div class="glass stat-card">
        <div class="value" id="system-status">-</div>
        <div class="label">System Status</div>
    </div>
    <div class="glass stat-card">
        <div class="value" id="db-size">-</div>
        <div class="label">Database Size</div>
    </div>
    <div class="glass stat-card">
        <div class="value" id="last-collection">-</div>
        <div class="label">Last Data Collection</div>
    </div>
    <div class="glass stat-card">
        <div class="value" id="model-accuracy">-</div>
        <div class="label">Model Accuracy</div>
    </div>
</div>

<!-- Data Management -->
<div class="glass card mb-1">
    <h3>Data Management</h3>
    <div class="grid-2 gap-1">
        <div>
            <label>Number of Cryptocurrencies</label>
            <input type="number" id="data-limit" value="500" min="100" max="1000" step="100" style="margin-bottom: 0.5rem;">
            <button class="btn btn-primary" onclick="collectData()" style="width: 100%;">Collect Data from CoinGecko</button>
        </div>
        <div>
            <label>Update Existing Data</label>
            <div style="margin-bottom: 0.5rem; height: 2.4rem; display: flex; align-items: center;">
                <span class="text-muted" style="font-size: 0.85rem;">Updates prices and metrics for existing cryptocurrencies</span>
            </div>
            <button class="btn btn-secondary" onclick="updateData()" style="width: 100%;">Update Price Data</button>
        </div>
    </div>
    <div id="collection-progress" style="display: none; margin-top: 1rem;">
        <div class="metric-row">
            <span class="metric-label">Status</span>
            <span class="metric-value" id="collection-status">-</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Progress</span>
            <span class="metric-value" id="collection-progress-text">-</span>
        </div>
    </div>
</div>

<!-- Model Training -->
<div class="glass card mb-1">
    <h3>Model Training</h3>
    <div class="grid-3 gap-1">
        <div>
            <label>Target Metric</label>
            <select id="train-metric" style="margin-bottom: 0;">
                <option value="price_1yr_change">1-Year Change</option>
                <option value="price_90d_change">90-Day Change</option>
                <option value="price_30d_change">30-Day Change</option>
            </select>
        </div>
        <div style="display: flex; flex-direction: column; justify-content: flex-end;">
            <button class="btn btn-success" onclick="trainModel()" style="width: 100%;">Train Prediction Model</button>
        </div>
        <div style="display: flex; flex-direction: column; justify-content: flex-end;">
            <button class="btn btn-outline" onclick="validateModel()" style="width: 100%;">Validate Model</button>
        </div>
    </div>
    <div id="training-results" style="display: none; margin-top: 1rem;">
        <div class="grid-3">
            <div class="metric-row">
                <span class="metric-label">RÂ² Score</span>
                <span class="metric-value" id="train-r2">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">MAE</span>
                <span class="metric-value" id="train-mae">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Training Time</span>
                <span class="metric-value" id="train-time">-</span>
            </div>
        </div>
    </div>
</div>

<!-- Export & Backup -->
<div class="glass card mb-1">
    <h3>Export & Backup</h3>
    <div class="grid-3 gap-1">
        <button class="btn btn-outline" onclick="exportData('csv')">
            Export CSV
        </button>
        <button class="btn btn-outline" onclick="exportData('json')">
            Export JSON
        </button>
        <button class="btn btn-outline" onclick="exportAnalysis()">
            Export Analysis Report
        </button>
    </div>
</div>

<!-- System Information -->
<div class="glass card">
    <h3>System Information</h3>
    <div id="system-info">
        <div class="metric-row">
            <span class="metric-label">Total Cryptocurrencies</span>
            <span class="metric-value" id="info-total-cryptos">-</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Completed Analyses</span>
            <span class="metric-value" id="info-total-analyses">-</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Price History Records</span>
            <span class="metric-value" id="info-total-prices">-</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">API Status</span>
            <span class="metric-value" id="info-api-status">-</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadSystemInfo() {
    try {
        const status = await fetch('/api/data/status').then(r => r.json());
        
        document.getElementById('system-status').textContent = status.api_status || 'Unknown';
        document.getElementById('system-status').className = 'value ' + (status.api_status === 'connected' ? 'text-success' : 'text-danger');
        
        document.getElementById('db-size').textContent = status.total_cryptocurrencies || 0;
        document.getElementById('last-collection').textContent = status.last_crypto_update ? new Date(status.last_crypto_update).toLocaleDateString() : 'Never';
        
        document.getElementById('info-total-cryptos').textContent = status.total_cryptocurrencies || 0;
        document.getElementById('info-total-analyses').textContent = status.total_analyses || 0;
        document.getElementById('info-api-status').textContent = status.api_status || 'Unknown';
        
        // Load model accuracy
        const accuracy = await fetch('/api/model/accuracy').then(r => r.json()).catch(() => ({accuracy_percent: 0}));
        document.getElementById('model-accuracy').textContent = (accuracy.accuracy_percent || 0) + '%';
        
    } catch (error) {
        console.error('Error loading system info:', error);
    }
}

async function collectData() {
    const limit = parseInt(document.getElementById('data-limit').value);
    
    if (!confirm(`Collect data for ${limit} cryptocurrencies? This may take several minutes.`)) {
        return;
    }
    
    try {
        document.getElementById('collection-progress').style.display = 'block';
        document.getElementById('collection-status').textContent = 'Running...';
        document.getElementById('collection-progress-text').textContent = '0%';
        
        const response = await fetch('/api/data/collect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ limit })
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('collection-status').textContent = 'Complete';
            document.getElementById('collection-status').className = 'metric-value positive';
            document.getElementById('collection-progress-text').textContent = `${result.stats.cryptocurrencies_added + result.stats.cryptocurrencies_updated} cryptos`;
            
            alert(`Data collection complete!\n\nCryptocurrencies: ${result.stats.cryptocurrencies_added + result.stats.cryptocurrencies_updated}\nAnalyses: ${result.stats.name_analyses_added}\nPrice records: ${result.stats.price_histories_added}`);
            
            loadSystemInfo();
        } else {
            throw new Error(result.error || 'Collection failed');
        }
    } catch (error) {
        console.error('Collection error:', error);
        document.getElementById('collection-status').textContent = 'Failed';
        document.getElementById('collection-status').className = 'metric-value negative';
        alert('Error collecting data: ' + error.message);
    }
}

async function updateData() {
    if (!confirm('Update price data for existing cryptocurrencies?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/data/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Updated ${result.stats.updated} cryptocurrencies`);
            loadSystemInfo();
        }
    } catch (error) {
        console.error('Update error:', error);
        alert('Error updating data');
    }
}

async function trainModel() {
    const metric = document.getElementById('train-metric').value;
    
    try {
        document.getElementById('training-results').style.display = 'block';
        document.getElementById('train-r2').textContent = 'Training...';
        
        const response = await fetch('/api/predict/train', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ metric })
        });
        
        const result = await response.json();
        
        if (result.success && result.scores) {
            document.getElementById('train-r2').textContent = result.scores.r2?.toFixed(3) || '-';
            document.getElementById('train-mae').textContent = result.scores.mae?.toFixed(2) || '-';
            document.getElementById('train-time').textContent = '< 1s';
            
            alert('Model training complete!');
        }
    } catch (error) {
        console.error('Training error:', error);
        alert('Error training model');
    }
}

async function validateModel() {
    alert('Model validation will compare predictions against actual performance over the last 30 days.');
    // Implementation would call model accuracy endpoint
}

function exportData(format) {
    window.location.href = `/api/export/${format}`;
}

function exportAnalysis() {
    alert('Exporting comprehensive analysis report...');
    window.location.href = '/api/export/json';
}

// Load on page load
loadSystemInfo();
</script>
{% endblock %}

